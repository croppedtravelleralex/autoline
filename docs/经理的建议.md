# 线体监控软件优化建议书

**版本**：v1.3 (深度算法研讨版)
**项目经理**：Antigravity
**日期**：2026-01-18

---

## 一、 核心架构重构 (Critical - R&D Dept)

1.  **后端状态机（Single Source of Truth）**
    *   **要求**：建立后端常驻内存的状态机（State Machine）。所有设备状态（温度、压力、阀门位号、小车位置）均由后端由 `SystenState` 全权维护。前端仅作为“纯展示层”。
    *   **架构升级**：引入 **Edge Computing (边缘计算)** 概念，即使与上层 MES 断网，本地线体控制必须独立存活至少 24小时，并具备数据本地缓存能力。

2.  **数据模型统一与归档**
    *   **要求**：后端模型必须包含 `exterior_temperature`（外温）与 `interior_temperature`（内温）。
    *   **新增**：引入时序数据库 (Time-Series DB) 设计思维，为每秒产生的大量传感器数据预留高性能读写接口。

3.  **强制互锁与安全校验**
    *   **要求**：后端 API 层必须实现强制互锁拦截。
        *   *Example*: 当 `gate_valve` 为 `open` 时，若 `vent_valve` 触发开启，后端需返回 HTTP 409 并触发声光报警。

---

## 二、 经理与算法组深度研讨 (Manager vs Algorithm Group)

本次研讨会重点审视了《软件需求规格说明书》中关于复杂工艺流程与自动化控制的实现难点。

### 1. 动态调度算法 (Dynamic Scheduling Algorithm)
*   **挑战**: 阳极与阴极线流程差异巨大，且存在刚性时序约束。
    *   *阳极*: 进样(30m) -> 烘烤(>12h) -> 冷却(>12h) -> 清刷(5.5h) -> 对接(4h) -> 压封(4h)。
    *   *阴极*: 进样(30m) -> 烘烤(10-24h) -> 生长(>4h, 需等待除气完成) -> 联动铟封。
*   **算法组对策**:
    *   **摒弃定式排程**: 不能简单使用 `setTimeout`。必须构建 **DAG (有向无环图)** 任务调度引擎。
    *   **死锁预防**: 针对“对接仓”这一公共资源（阳极需在此等待压封，阴极需联动），算法需预判“交通拥堵”。若预测到未来 4小时内对接仓无空位，应提前延迟上游进样，避免小车在高温区滞留超时。
    *   **自适应节拍**: 当“阴极生长”通过 APC 判定生长缓慢（超过预计 4h），系统应自动重算下游所有待办事项的 `ETA` (预计到达时间)，并推送到前端“线体待办事项”看板。

### 2. 真空度变化率监控 (Vacuum Rate & Process Trigger)
*   **需求**: “基于真空度阈值的自动流程推进”及“变化率监控”。
*   **算法组对策**:
    *   **一阶导数判据**: 仅监控绝对压力值是不够的。算法将实时计算 $dP/dt$ (压力变化率)。
        *   *场景*: 当 $P < 5 \times 10^{-4} Pa$ 且 $|dP/dt| < 10^{-6} Pa/s$ (即状态极其稳定) 时，才判定为“工艺达标”，自动触发下一工序。这比单纯看绝对值更安全。
    *   **虚空报警抑制**: 在粗抽初期，压力波动剧烈。算法需引入 **Kalman Filter (卡尔曼滤波)** 对传感器原始数据进行平滑处理，防止因规管跳动误触发“泄露报警”。

### 3. 智能路径规划与状态感知
*   **需求**: 前端需显示“进度条”与“下一步骤”。
*   **算法组对策**:
    *   **模糊状态机**: 针对“烘烤 > 10小时 且 < 24小时”这种弹性区间，算法将引入模糊逻辑。
        *   *进度条逻辑*: 前 10小时为“强制期”（进度 0-80%），10-24小时为“浮动期”（进度 80-99%），只有工艺员确认或除气达标后才跳至 100%。

---

## 三、 仿真模拟精细化指标 (Simulation Specs - Process Dept)

### 1. 温度控制模型 (Thermodynamic Model)
*   **阳极线 - 烘烤仓**: 10h 线性升温 (25->390) -> 快速降温 -> 5h 自然冷却。
*   **阳极线 - 对接仓**: 外温 120-130℃，内温 90-100℃（恒温波动）。
*   **阴极线 - 烘烤/生长**: 遵循 Process Active 状态下的升降温逻辑。

### 2. 真空度模型
*   **抽气**: 对数衰减模型。
*   **漏率**: 模拟基准漏率与随机微漏异常。

---

## 四、 结论与下阶段

**P0 级开发任务 (Immediate Actions)**:
1.  **后端状态机**: 实现 SystemState 与 Pydantic 模型。
2.  **调度引擎原型**: 编写 Python 脚本模拟上述 DAG 调度逻辑，验证阳极/阴极流程在无干预下的流转闭环。
3.  **数据仿真**: 落实温度与真空度的物理算法。

请研发团队依据此文档，优先构建具备“调度智能”与“物理真实感”的后端核心。
